var state = {
  pg: { path: [], timeout: 0} ,
  sg: { path: [], timeout: 0},
  sf: { path: [], timeout: 0},
  pf: { path: [], timeout: 0},
  c: { path: [], timeout: 0}
}
var isDragging = false;

// var path = JSON.parse('[{"x":0,"y":-1.33331298828125},{"x":-1.33331298828125,"y":-11.333343505859375},{"x":-0.66668701171875,"y":-4},{"x":-0.666656494140625,"y":-6},{"x":-0.666656494140625,"y":-5.333343505859375},{"x":-0.66668701171875,"y":-4.666656494140625},{"x":-1.33331298828125,"y":-8.666656494140625},{"x":-0.66668701171875,"y":-3.333343505859375},{"x":-1.33331298828125,"y":-6},{"x":-0.66668701171875,"y":-2.666656494140625},{"x":-1.33331298828125,"y":-6},{"x":-1.333343505859375,"y":-4},{"x":-2,"y":-8},{"x":-0.666656494140625,"y":-2.66668701171875},{"x":-1.333343505859375,"y":-10},{"x":-1.333343505859375,"y":-4},{"x":-0.666656494140625,"y":-8.666656494140625},{"x":0,"y":-6.666656494140625},{"x":0,"y":-13.333343505859375},{"x":0,"y":-0.666656494140625},{"x":-1.333343505859375,"y":-18},{"x":-0.666656494140625,"y":-6},{"x":-2.666656494140625,"y":-14.000015258789062},{"x":-0.66668701171875,"y":-2.6666717529296875},{"x":0,"y":-8.666656494140625},{"x":0,"y":-8.666671752929688},{"x":0,"y":-4},{"x":0,"y":-3.3333282470703125},{"x":0,"y":-6.6666717529296875},{"x":0,"y":-6.6666717529296875},{"x":0,"y":-6},{"x":-0.666656494140625,"y":-10},{"x":0,"y":-9.333328247070312},{"x":0,"y":-6.6666717529296875},{"x":0,"y":-7.3333282470703125},{"x":0,"y":-2},{"x":0,"y":-8},{"x":0,"y":-5.3333282470703125},{"x":0.666656494140625,"y":-6.6666717529296875},{"x":0.66668701171875,"y":-2.6666717529296875},{"x":0.666656494140625,"y":-6},{"x":0.666656494140625,"y":-2.666656494140625},{"x":1.333343505859375,"y":-5.333343505859375},{"x":0,"y":-1.3333282470703125},{"x":2.666656494140625,"y":-10.666671752929688},{"x":0,"y":-2.6666641235351562},{"x":0.66668701171875,"y":-2},{"x":0.666656494140625,"y":-2},{"x":1.333343505859375,"y":0},{"x":2.666656494140625,"y":4},{"x":3.333343505859375,"y":6},{"x":6,"y":12.666664123535156},{"x":3.33331298828125,"y":7.333343505859375},{"x":6,"y":16},{"x":4.66668701171875,"y":13.333328247070312},{"x":4.666656494140625,"y":16.666671752929688},{"x":5.333343505859375,"y":14.666656494140625},{"x":5.33331298828125,"y":14.666671752929688},{"x":1.333343505859375,"y":4.6666717529296875},{"x":3.333343505859375,"y":16},{"x":2.666656494140625,"y":7.3333282470703125},{"x":2,"y":10.666671752929688},{"x":0.666656494140625,"y":2.666656494140625},{"x":3.333343505859375,"y":16.66668701171875},{"x":0.666656494140625,"y":4.666656494140625},{"x":0.66668701171875,"y":2.666656494140625},{"x":0,"y":5.333343505859375},{"x":0.666656494140625,"y":9.333343505859375},{"x":0,"y":2},{"x":0,"y":8},{"x":0,"y":0.666656494140625},{"x":-0.666656494140625,"y":12.666656494140625},{"x":0,"y":4.66668701171875},{"x":-2,"y":7.33331298828125},{"x":-2.66668701171875,"y":7.333343505859375},{"x":-2,"y":2.666656494140625},{"x":-2.666656494140625,"y":3.333343505859375},{"x":-2,"y":2},{"x":-5.333343505859375,"y":4},{"x":-4,"y":3.333343505859375},{"x":-8,"y":4},{"x":-6.666656494140625,"y":2.666656494140625},{"x":-7.333343505859375,"y":3.333343505859375},{"x":-8.666656494140625,"y":1.33331298828125},{"x":-6.666656494140625,"y":0.66668701171875},{"x":-7.333343505859375,"y":0},{"x":-5.333343505859375,"y":0},{"x":-12,"y":-1.333343505859375},{"x":-11.33331298828125,"y":-2},{"x":-18.66668701171875,"y":-5.333343505859375},{"x":-2.666656494140625,"y":-1.33331298828125},{"x":-22,"y":-14.66668701171875},{"x":-6,"y":-7.33331298828125},{"x":-5.333343505859375,"y":-8},{"x":-3.33331298828125,"y":-10.333343505859375},{"x":-6.66668701171875,"y":-23.666656494140625},{"x":-0.666656494140625,"y":-7.333343505859375},{"x":0,"y":-28},{"x":0,"y":-15.333343505859375},{"x":1.333343505859375,"y":-17.666656494140625},{"x":1.33331298828125,"y":-13},{"x":5.333343505859375,"y":-12.666671752929688},{"x":2.666656494140625,"y":-5.3333282470703125},{"x":4,"y":-6},{"x":8,"y":-13.333343505859375},{"x":12.66668701171875,"y":-11},{"x":4,"y":-3.3333282470703125},{"x":10,"y":-4},{"x":18.666656494140625,"y":-5},{"x":17.333343505859375,"y":-2.6666717529296875},{"x":12.666656494140625,"y":-0.666656494140625},{"x":2.666656494140625,"y":0},{"x":30.66668701171875,"y":5.3333282470703125},{"x":4.666656494140625,"y":1.3333282470703125},{"x":16.666656494140625,"y":10},{"x":7.333343505859375,"y":6.6666717529296875},{"x":23.333343505859375,"y":37.33332824707031},{"x":4.666656494140625,"y":15.333343505859375},{"x":4,"y":20.666656494140625},{"x":0.666656494140625,"y":7.333343505859375},{"x":0,"y":8.666656494140625},{"x":0,"y":6.66668701171875},{"x":-5.33331298828125,"y":14},{"x":-4,"y":10},{"x":-7.333343505859375,"y":12},{"x":-6.666656494140625,"y":8},{"x":-10.66668701171875,"y":14.666656494140625},{"x":-3.33331298828125,"y":4.666656494140625},{"x":-10,"y":13.333343505859375},{"x":-7.333343505859375,"y":6},{"x":-7.333343505859375,"y":6},{"x":-5.33331298828125,"y":3.333343505859375},{"x":-7.333343505859375,"y":2.666656494140625},{"x":-4.666656494140625,"y":0.666656494140625},{"x":-8.66668701171875,"y":3.333343505859375},{"x":-5.33331298828125,"y":0.666656494140625},{"x":-4,"y":1.333343505859375},{"x":-8,"y":1.333343505859375},{"x":-4,"y":0.666656494140625},{"x":-1.333343505859375,"y":0.666656494140625},{"x":-0.666656494140625,"y":0}]');

function move(elem, i) {
  setTimeout(function() {
    var x = parseFloat((elem.getAttribute('data-x')) || 0) + state[elem.id].path[i].x;
    var y = parseFloat((elem.getAttribute('data-y')) || 0) + state[elem.id].path[i].y;

    elem.style.transform = elem.style.webkitTransform = `translate(${x}px, ${y}px)`;

    elem.setAttribute('data-x', x);
    elem.setAttribute('data-y', y);

    if (i + 1 < state[elem.id].path.length) {
      move(elem, i + 1);
    } else {
      state[elem.id].path = []
    }
  }, state[elem.id].timeout)
}

interact('.player').draggable({
  inertia: false,
  max: Infinity,
  autoscroll: true,
  // keep the element within the area of it's parent
  restrict: {
    restriction: 'parent',
    endOnly: true,
    elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
  },  
  onmove: dragMoveListener,
  onend: function(event) {
    console.log('Moved ' + event.target.id);
    state[event.target.id].timeout = 1000 / state[event.target.id].path.length;
    // setTimeout(() => {
    //   init();
    //   move(event.target, 0);
    // }, 1000)
  }
});


function dragMoveListener(event) {
  var target = event.target;
  
  // keep the dragged position in the data-x/data-y attributes
  var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
  var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

  // translate the element
  target.style.webkitTransform =
  target.style.transform =
    'translate(' + x + 'px, ' + y + 'px)';

  // update the posiion attributes
  target.setAttribute('data-x', x);
  target.setAttribute('data-y', y);

  state[target.id].path.push({
    x: event.dx, y: event.dy
  })

  console.log(`Translating x: ${event.dx} y: ${event.dy}`)
}

window.dragMoveListener = dragMoveListener;

var pg = document.getElementById('pg');
var sg = document.getElementById('sg');
var sf = document.getElementById('sf');
var pf = document.getElementById('pf');
var c = document.getElementById('c');

var starting = {
  'pg': {'top': '400px', 'left': '400px'},
  'sg': {'top': '300px', 'left': '100px'},
  'sf': {'top': '300px', 'left': '700px'},
  'pf': {'top': '200px', 'left': '300px'},
  'c' : {'top': '50px', 'left': '500px'}
}

function init() {
  pg.setAttribute('style', `top: ${starting.pg.top}; left: ${starting.pg.left};`);
  sg.setAttribute('style', `top: ${starting.sg.top}; left: ${starting.sg.left};`);
  sf.setAttribute('style', `top: ${starting.sf.top}; left: ${starting.sf.left};`);
  pf.setAttribute('style', `top: ${starting.pf.top}; left: ${starting.pf.left};`);
  c.setAttribute('style', `top: ${starting.c.top}; left: ${starting.c.left};`);

  pg.setAttribute('data-x', 0);
  pg.setAttribute('data-y', 0);
  sg.setAttribute('data-x', 0);
  sg.setAttribute('data-y', 0);
  sf.setAttribute('data-x', 0);
  sf.setAttribute('data-y', 0);
  pf.setAttribute('data-x', 0);
  pf.setAttribute('data-y', 0);
  c.setAttribute('data-x', 0);
  c.setAttribute('data-y', 0);
}
// emulate();
init();

document.getElementById('replay').addEventListener('click', function(event) {
  init();
  for (var player in state) {
    move(document.getElementById(player), 0);
  }
});